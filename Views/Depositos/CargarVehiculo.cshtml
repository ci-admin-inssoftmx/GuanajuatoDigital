@model GuanajuatoAdminUsuarios.Models.SolicitudDepositoModel
@{
    @inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor;
    var listaIdsPermitidosJson = @HttpContextAccessor.HttpContext.Session.GetString("IdsPermitidos").ToString();
    var folioSolicitud = ViewBag.FolioSolicitud;
    ViewData["FolioSolicitud"] = folioSolicitud;
}

<script>
    $(document).ready(function () {
        var access = @listaIdsPermitidosJson;
        if (access != undefined && access != '') {
            if (!access.toString().includes(localStorage.getItem("menuId"))) {
                Swal.fire({
                    icon: "error",
                    title: "¡EL usuario no tiene acceso a esta opción!"
                });
                setTimeout(() => {
                    window.location.href = "/Principal";
                }, 200);
            }
        } else {
            Swal.fire({
                icon: "error",
                title: "¡EL usuario no tiene acceso a esta opción!"
            });
            setTimeout(() => {
                window.location.href = "/Principal";
            }, 200);
        }
    });
</script>

<div class="mainContainer bg-light">
    <section class="mx-md-3 mx-lg-4 mx-xl-5 bg-white boxShadow my-5 rounded">
        <div class="row align-items-center justify-content-between px-4 px-md-4 pt-3 pb-2">
            <div class="col-12 col-md-auto pe-0">
                <div class="row align-items-center justify-content-center justify-content-md-start">
                    <div class="col-auto">
                        <div class="border border-2 border-dark rounded-circle">
                            <h5 class="m-0 numberCard d-flex align-items-center justify-content-center">
                                <b>1</b>
                            </h5>
                        </div>
                    </div>
                    <div class="col-auto p-0">
                        <i class="icon-car h1 colorPrimary"></i>
                    </div>
                    <div class="col-auto my-3">
                        <h2 class="m-0 h3"><b>Captura de vehículo</b></h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="bgSuccess py-1"></div>
            </div>            
        </div>
        <div class="row">
            <div class="col-12 col-lg-9 my-2">
                <h5 class="px-4 d-flex align-items-center"><b>Búsqueda del vehículo</b></h5>
                <h6 class="px-4 text-muted">Realiza una búsqueda del vehículo para conocer si ya está capturado en Registro de Infracciones y Accidentes de Guanajuato o de lo contrario importar los datos del registro estatal.</h6>
            </div>
            <div class="col-12 col-lg-3 my-2">
                <div class="row">
                    <div class="col-auto btnOutline btnOutlinePrimary my-2 p-0">
                        <button id="btnNuevoVehiculo" onclick="mostrarModalAgregarVehiculo()" type="button">
                            <h6 class="m-0 d-flex align-items-center"><i class="icon-addCar h5 mb-0 me-2"></i><b>Agregar nuevo vehículo</b></h6>
                        </button>
                    </div>
                </div>
            </div>
        </div>    
        <div class="row align-items-center justify-content-between px-4 px-md-4 pt-0 pb-2">
            <form id="filterForm">
                <div class="row">
                    <div class="controlForm my-1 col-12 col-md-6 col-lg-4">
                        <span>
                            <label>Entidad de registro:</label>
                            @(Html.Kendo().DropDownList()
                                .Name("EntidadRegistro")
                                .OptionLabel("Selecciona la entidad de registro")
                                .DataTextField("Text")
                                .DataValueField("Value")
                                .Filter(FilterType.Contains)
                                .DataSource(source =>
                                {
                                    source.Read(read =>
                                    {
                                        read.Action("GetEntidades_Drop", "BusquedaVehiculoPropietario");
                                    });
                                })
                                .HtmlAttributes(new { style = "width: 100%", Id = "entidad-registro" })
                                )
                        </span>
                    </div>                                        
                </div>
                <div class="row justify-content-between">
                    <div class="controlForm my-1 col-12 col-md-6 col-lg-4">
                        <span>
                            @(Html.Kendo().TextBox()
                                .Name("Placa")
                                .Placeholder("Ingresa el número de placa del vehículo")
                                .Label(l => l.Content("Placa:"))
                                .HtmlAttributes(new { style = "width: 100%", Id = "placa" })
                                )
                        </span>
                    </div>
                    <div class="controlForm my-1 col-12 col-md-6 col-lg-5">
                        <span>
                            @(Html.Kendo().TextBox()
                                .Name("Serie")
                                .Placeholder("Ingresa el número de serie valido")
                                .Label(l => l.Content("Serie:"))
                                .HtmlAttributes(new { style = "width: 100%", Id = "serie" })
                                )
                        </span>
                    </div>
                    <div class="col-12 my-1 col-md-6 col-lg-3 align-self-end">
                        <div class="controlButton">
                            <button class="btnPrimary" type="button" onclick="submitSearch()">
                                <h5 class="m-0"><b>Buscar</b></h5>
                            </button>
                        </div>
                    </div>
                </div>
                
            </form>            
        </div>
        <div class="row my-4 px-4">
            <div id="listadoVehiculos">
                <partial name="_ListadoVehiculos" model="ViewBag.Vehiculos" view-data=ViewData/>
            </div>
        </div>
    </section>
</div>

<!-- modals -->
<div class="modal fade modalCustom" id="agregarVehiculoModal" aria-labelledby="agregarVehiculoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body" id="ModalBodyAgregarVehiculo">
            </div>
        </div>
    </div>
</div>

<div class="modal fade modalCustom" id="VehiculoServiceModal" aria-labelledby="VehiculoServiceLabel2" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body" id="ModalBodyVehiculoService">
            </div>
        </div>
    </div>
</div>

<script>
    function abrirModalPersonaMoral() {
        $.ajax({
            url: '@Url.Action("MostrarPersonaMoral", "BusquedaVehiculoPropietario")',
            type: 'GET',
            data: {},
            success: function (result) {
                $('#personaMoralContainer').html(result);
                $('#addMoral').modal('show');
            },
            error: function (xhr, textStatus, errorThrown) {
                console.error("Error en la solicitud AJAX:", textStatus, errorThrown);
            }
        });
    }

    function onDataBound() {
        var grid = $("#gridPersonasMorales").data("kendoGrid");
        if (grid.dataSource.total() === 1) {
            setTimeout(function () {
                var row = grid.tbody.find("tr:first");
                grid.select(row);
                row.find(".k-checkbox").trigger("click");
            }, 50);
        }
    }

    function subMarcaDropDownChange() {
        var _idMarca = $("#ddlMarcas").data("kendoDropDownList").value();
        showLoading();
        $.ajax({
            url: "/Vehiculos/SubMarcasActive_ReadPorMarca",
            type: "POST",
            data: { idMarca: _idMarca },
            success: function (data) {
                var TramosDropDown = $("#idSubmarca").data("kendoDropDownList");
                TramosDropDown.dataSource.data(data);
                hideLoading();
            },
            error: function (xhr, status, error) {
                console.log("EE", error)
                hideLoading();
            }
        });
    }


    function mostrarModalAgregarVehiculo() {
        $.ajax({
            url: '@Url.Action("ModalAgregarVehiculo")',
            type: 'POST',
            success: function (data) {
                $('#ModalBodyAgregarVehiculo').html(data);
                $('#agregarVehiculoModal').modal('show');
            }
        });
    }


    function submitSearch() {
		let form = document.getElementById('filterForm');
        let filterForm = new FormData(form);
        
        searchFilter = {
            IdEntidadBusqueda: filterForm.get('EntidadRegistro'),
            PlacasBusqueda: filterForm.get('Placa'),
            SerieBusqueda: filterForm.get('Serie')
        };

        console.log(searchFilter);

        let grid = $("#gridVehiculos").data("kendoGrid");

        isSubmitSearch = true;

        grid.one("dataBound", function (e) {
            if (!isSubmitSearch) {
                return;
            }

            if (grid.dataSource.total() === 0) {
                busquedaVehiculoPorPlataforma(searchFilter)                                
            }
            if (grid.dataSource.total() === 1) {                
                var selectedRow = grid.table.find("tr:eq(0)");
                grid.select(selectedRow);
                $(document).trigger("vehiculoEncontrado", [selectedRow]);
            }            
            isSubmitSearch = false;
        });

        grid.dataSource.read();
         
	}

    function applySearchFilter() {
        return { filtroBusqueda: searchFilter };
    }

    function busquedaVehiculoPorPlataforma(filtro) {
        showLoading();
        $.ajax({
            url: '@Url.Action("BuscarVehiculoPorPlataforma")',
            type: 'POST',
            data: filtro,
            success: function (response) {                
                if (response.success === false) {
                    sitteg_warning("No se encontraron resultados");
                    return;
                }

                if (response.noResults) {
                    Swal.fire({
                        icon: "info",
                        title: "Vehículo no registrado en RIAG",
                        text: "¡Vehículo sin captura en el Registro de Infracciones y Accidentes de Guanajuato!",
                        showCancelButton: true,
                        showConfirmButton: false,
                        cancelButtonText: "Cerrar",
                    });
                    
                    $('#ModalBodyVehiculoService').html(response.data);
                    $('#VehiculoServiceModal').modal({ backdrop: 'static', keyboard: false });
                    $('#VehiculoServiceModal').modal('show');
                    hideLoading();
                } else if (response.data) {

                    try {
                    
                        let grid = $("#gridVehiculos").data("kendoGrid");
                        let vehiculoFoundByFilter = true;
                        grid.one("dataBound", function () {
                            var data = grid.dataSource.view();
                            if (data.length === 1 && vehiculoFoundByFilter) {
                                var selectedRow = grid.table.find("tr:eq(0)");
                                grid.select(selectedRow);
                                $(document).trigger("vehiculoEncontrado", [selectedRow]);
                            }

                            vehiculoFoundByFilter = false;
                        });
                        
                        grid.dataSource.filter({ field: response.field, operator: "contains", value: response.data })
                    }
                    catch {

                    }
                    setTimeout(() => { $('#agregarVehiculoModal').modal('hide'); }, 400)
                    hideLoading();
                } else {
                    $('#agregarVehiculoModal').modal('hide');
                    hideLoading();
                    sitteg_warning('Sucedio un error intente de nuevo mas tarde.');
                }

            },
            error: function () {                
                sitteg_warning("Sucedio un error intente de nuevo mas tarde");
                hideLoading();
            }
        });
    }

    let searchFilter = {};

    function handleVehiculoEvent(event, selectedRow) {
        let grid = $("#gridVehiculos").data("kendoGrid");
        let dataItem = grid.dataItem(selectedRow);
        if (dataItem) {
            updateDepositoVehiculo(dataItem.idVehiculo);
        } else {
            console.error("No se pudo obtener el dataItem del vehículo seleccionado.");
        }
    }

    $(document).ready(function () {

        $(document).on("vehiculoCreado", handleVehiculoEvent);
        
        $(document).on("vehiculoEncontrado", handleVehiculoEvent);

    });

</script>