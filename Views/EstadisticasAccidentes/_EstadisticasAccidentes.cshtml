@model List<EstadisticaAccidentesMotivosModel>


<div class="row my-4 px-4">
	<div class="col-md-6">
		<button type="button" class="btn btn-outline-success" onclick="generateExcel()">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-xls" viewBox="0 0 16 16">
				<path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM6.472 15.29a1.176 1.176 0 0 1-.111-.449h.765a.578.578 0 0 0 .254.384c.07.049.154.087.25.114.095.028.202.041.319.041.164 0 .302-.023.413-.07a.559.559 0 0 0 .255-.193.507.507 0 0 0 .085-.29.387.387 0 0 0-.153-.326c-.101-.08-.255-.144-.462-.193l-.619-.143a1.72 1.72 0 0 1-.539-.214 1.001 1.001 0 0 1-.351-.367 1.068 1.068 0 0 1-.123-.524c0-.244.063-.457.19-.639.127-.181.303-.322.527-.422.225-.1.484-.149.777-.149.305 0 .564.05.78.152.216.102.383.239.5.41.12.17.186.359.2.566h-.75a.56.56 0 0 0-.12-.258.625.625 0 0 0-.247-.181.923.923 0 0 0-.369-.068c-.217 0-.388.05-.513.152a.472.472 0 0 0-.184.384c0 .121.048.22.143.3a.97.97 0 0 0 .405.175l.62.143c.217.05.406.12.566.211a1 1 0 0 1 .375.358c.09.148.135.335.135.56 0 .247-.063.466-.188.656a1.216 1.216 0 0 1-.539.439c-.234.105-.52.158-.858.158-.254 0-.476-.03-.665-.09a1.404 1.404 0 0 1-.478-.252 1.13 1.13 0 0 1-.29-.375Zm-2.945-3.358h-.893L1.81 13.37h-.036l-.832-1.438h-.93l1.227 1.983L0 15.931h.861l.853-1.415h.035l.85 1.415h.908L2.253 13.94l1.274-2.007Zm2.727 3.325H4.557v-3.325h-.79v4h2.487v-.675Z"></path>
			</svg>
			Generar excel
		</button>


		@(Html.Kendo().Grid(Model)
			.Name("gridInfraccionesPersonas1")
			.Excel(ex => ex.AllPages(true))
			.Columns(columns =>
			{
				columns.Bound(c => c.Delegacion).Title("Delegación");
				columns.Bound(c => c.Motivo).Title("Municipio");
				columns.Bound(p => p.Contador).Title("Totales").Format("{0:n0}").ClientFooterTemplate("Total : #= kendo.toString(sum, \"n0\")#");
			})
			//.Events(events => events.ExcelExport("ConteoPorMunicipio_excelExport")) // Agregar el manejador de eventos ExcelExport
			@*.Pageable(pager => pager.AlwaysVisible(false).Position(GridPagerPosition.Bottom).PageSizes(false))*@
			.Pageable(p => p.Enabled(true))
			.Sortable()
			.Scrollable(scr => scr.Enabled(false))
			.DataSource(dataSource => dataSource
			.Ajax()
			.ServerOperation(false)
			.Aggregates(aggregates =>
			{
				aggregates.Add(p => p.Contador).Sum();
			}))

			.Events(events => events.ExcelExport("gridInfraccionesPersonas_ExportExcel"))

			.Events(events => events.DataBound("replaceLegend").DataBinding("replaceLegend"))

			)
	</div>
	<div class="col-md-6">
		<button class="btn btn-outline-success" type="button" id="cambiarTipo">Cambiar tipo de gráfica</button>
		@(Html.Kendo().Chart(Model)
			.Name("chart")
			.Title("Accidentes")
			.Subtitle("/Motivos Infracciones/")
			.Legend(legend => legend
			.Visible(true)
			.Position(ChartLegendPosition.Top)
			)
			.ChartArea(chartArea => chartArea
			.Background("transparent")
			)
			.Series(series =>
			{
				series.Pie(model => model.Contador, model => model.Motivo);
			})
			.CategoryAxis(axis => axis
			.Categories(c => c.Motivo)
			.MajorGridLines(lines => lines.Visible(false))
			.Labels(labels => labels
			.Rotation(0) 
			)
			)
			.ValueAxis(axis => axis
			.Line(line => line.Visible(false))
			.MajorGridLines(lines => lines.Visible(true))
			)
			.Tooltip(tooltip => tooltip
			.Visible(true)
			.Template("#= dataItem.Motivo #: #= value #")
			)
			)

	</div>
</div>
<script>
	//function generateExcel() {
	//	var grid = $("#gridInfraccionesPersonas1").data("kendoGrid");
	//	var pageSize = grid.dataSource._data.length;
	//	var dataSourceTotal = grid.dataSource.total();
	//	grid.dataSource.pageSize(dataSourceTotal);
	//	grid.saveAsExcel();

	//	setTimeout(function () {
	//		grid.dataSource.pageSize(pageSize);
	//		sitteg_success('Archivo descargado correctamente');
	//	}, 300);
	//}


</script>


<script>
	var promises = [
		$.Deferred()
	];
	function gridInfraccionesPersonas_ExportExcel(e) {
		e.preventDefault();
		promises[0].resolve(e.workbook);
	}

	function generateExcel() {
		var grid = $("#gridInfraccionesPersonas1").data("kendoGrid");
		var pageSize = grid.dataSource._data.length;
		var dataSourceTotal = grid.dataSource.total();
		grid.dataSource.pageSize(dataSourceTotal);
		//grid.saveAsExcel();
		var exportPromises = [
			grid.saveAsExcel()
		];

		$.when.apply($, exportPromises)
			.then(function () {
				promises[0].resolve(grid.options.excel.workbook);

				$.when.apply($, promises)
					.then(function (infraccionesInfo) {
						var sheets = [
							infraccionesInfo.sheets[0],
						];

						sheets[0].title = "Por municipio";

						var workbook = new kendo.ooxml.Workbook({
							sheets: sheets
						});

						kendo.saveAs({
							dataURI: workbook.toDataURL(),
							fileName: "EstadisticasAccidentes.xlsx"
						});
					});


				setTimeout(function () {
					sitteg_success('Archivo descargado correctamente');
				}, 1500);
			});


	}
</script>

<script>
	$(document).ready(function () {
		var chart = $("#chart").data("kendoChart");

		$("#cambiarTipo").click(function () {
			if (chart.options.series[0].type === "pie") {
				chart.options.series[0].type = "column";  
				chart.options.categoryAxis.labels.rotation = 90; 
			} else {
				chart.options.series[0].type = "pie";  
				chart.options.categoryAxis.labels.rotation = 0;
			}

			chart.refresh();
		});
	});

</script>

