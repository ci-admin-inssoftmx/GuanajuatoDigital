@using GuanajuatoAdminUsuarios.Entity;
@model List<InfoInfraccion>
<script>
    function showLoader(e) {
        console.log("SI LOADER INICIO")
        showLoading();
        kendo.ui.progress($("#gridInfraccionesInfo"), true);
    }

    function hideLoader(e) {
        hideLoading()
        sitteg_success("Archivo descargado correctamente")
    }

</script>
<div class="row">
    <div class="col-12 mb-4 px-4 rounded gridCustom">
       @* <button type="button" id="btnGenerarExcel2" class="btn btn-outline-success" onclick="generateExcel2()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-xls" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM6.472 15.29a1.176 1.176 0 0 1-.111-.449h.765a.578.578 0 0 0 .254.384c.07.049.154.087.25.114.095.028.202.041.319.041.164 0 .302-.023.413-.07a.559.559 0 0 0 .255-.193.507.507 0 0 0 .085-.29.387.387 0 0 0-.153-.326c-.101-.08-.255-.144-.462-.193l-.619-.143a1.72 1.72 0 0 1-.539-.214 1.001 1.001 0 0 1-.351-.367 1.068 1.068 0 0 1-.123-.524c0-.244.063-.457.19-.639.127-.181.303-.322.527-.422.225-.1.484-.149.777-.149.305 0 .564.05.78.152.216.102.383.239.5.41.12.17.186.359.2.566h-.75a.56.56 0 0 0-.12-.258.625.625 0 0 0-.247-.181.923.923 0 0 0-.369-.068c-.217 0-.388.05-.513.152a.472.472 0 0 0-.184.384c0 .121.048.22.143.3a.97.97 0 0 0 .405.175l.62.143c.217.05.406.12.566.211a1 1 0 0 1 .375.358c.09.148.135.335.135.56 0 .247-.063.466-.188.656a1.216 1.216 0 0 1-.539.439c-.234.105-.52.158-.858.158-.254 0-.476-.03-.665-.09a1.404 1.404 0 0 1-.478-.252 1.13 1.13 0 0 1-.29-.375Zm-2.945-3.358h-.893L1.81 13.37h-.036l-.832-1.438h-.93l1.227 1.983L0 15.931h.861l.853-1.415h.035l.85 1.415h.908L2.253 13.94l1.274-2.007Zm2.727 3.325H4.557v-3.325h-.79v4h2.487v-.675Z"></path>
            </svg>
            Generar excel
        </button>*@
        @(
            Html.Kendo().Grid(Model)
            .Name("gridInfraccionesInfo")
            .Excel(ex => ex.AllPages(false))
            .Columns(columns =>
            {
                columns.Bound(c => c.Numero).Title("No.").Width(50);
                columns.Bound(c => c.Folio).Title("Folio").Width(150);
                columns.Bound(c => c.FolioTxt).Title("Folio-Txt").Width(150).Hidden();
                columns.Bound(c => c.TTOTTE).Title("TTO/TTE").Width(200);
                columns.Bound(c => c.Estatus).Title("Estatus").Width(200);
                columns.Bound(c => c.TipoCortesia).Title("Tipo Cortesía").Width(150);
                columns.Bound(c => c.Delegacion).Title("Delegación").Width(200);
                columns.Bound(c => c.Municipio).Title("Municipio").Width(190);
                columns.Bound(c => c.FechaInfraccion).Title("Fecha de Infracción").Width(250).Format("{0:dd/MM/yyyy}");
                columns.Bound(c => c.HoraInfraccion).Title("Hora de Infracción").Width(250).Format("{0:HH:mm}"); ;
                columns.Bound(c => c.FechaVencimiento).Title("Fecha Vencimiento").Width(200).Format("{0:dd/MM/yyyy}");
                columns.Bound(c => c.Carretera).Title("Carretera").Width(230);
                columns.Bound(c => c.Tramo).Title("Tramo").Width(230);
                columns.Bound(c => c.Kilometraje).Title("Kilómetro").Width(150);
                columns.Bound(c => c.NombreConductor).Title("Nombre Conductor").Width(300);
                columns.Bound(c => c.CURPConductor).Title("CURP Conductor").Width(200);
                columns.Bound(c => c.FechadeNacimiento).Title("Fecha de Nacimiento").Width(200).Format("{0:dd/MM/yyyy}");
                columns.Bound(c => c.DomicilioConductor).Title("Domicilio Conductor").Width(350);
                columns.Bound(c => c.LicenciaConductor).Title("Licencia Conductor").Width(280);
                columns.Bound(c => c.TipoPersFisica).Title("Prop. Pers. Fisica").Width(250);
                columns.Bound(c => c.TipoPersMoral).Title("Prop. Pers Moral").Width(150);
                columns.Bound(c => c.Propietario).Title("Propietario").Width(350);
                columns.Bound(c => c.OficialInfraccion).Title("Oficial Infracción").Width(350);
                columns.Bound(c => c.CalifSalarios).Title("Calif. Salarios").Width(200);
                columns.Bound(c => c.MontoCalif).Title("Monto Calif.").Width(150);
                columns.Bound(c => c.MontoPago).Title("Monto Pago").Width(150);
                columns.Bound(c => c.ReciboPago).Title("Recibo Pago").Width(250);
                columns.Bound(c => c.FechaPago).Title("Fecha Pago").Width(200).Format("{0:dd/MM/yyyy}");
                columns.Bound(c => c.Placas).Title("Placas").Width(200);
                columns.Bound(c => c.SerieVeh).Title("Serie Veh.").Width(150);
                columns.Bound(c => c.numeroEconomicoVeh).Title("No.económico").Width(200);
                columns.Bound(c => c.TarjetadeCirculacion).Title("Tarjeta de Circulación").Width(200);
                columns.Bound(c => c.Marca).Title("Marca").Width(200);
                columns.Bound(c => c.Submarca).Title("Submarca").Width(200);
                columns.Bound(c => c.Modelo).Title("Modelo").Width(150);
                columns.Bound(c => c.Color).Title("Color").Width(150);
                columns.Bound(c => c.EntidaddeReg).Title("Entidad de Reg.").Width(300);
                columns.Bound(c => c.TipodeVehículo).Title("Tipo de Vehículo").Width(200);
                columns.Bound(c => c.TipodeServicio).Title("Tipo de Servicio").Width(200);
                columns.Bound(c => c.SubtipodeServicio).Title("Subtipo de Servicio").Width(200);
                columns.Bound(c => c.TipoGarantia).Title("Tipo Garantía").Width(200);
                columns.Bound(c => c.TipoAplicacion).Title("Tipo Aplicación").Width(200);
                columns.Bound(c => c.Motivo).Title("Motivos").Width(150);
                columns.Bound(c => c.MotivoDesc).Title("Motivos (descripcion texto abierto)").Width(380);

            }).HtmlAttributes(new { style = "height:auto" })
            
            .DataSource(dataSource => dataSource
            
            .Ajax()
            .Read(read => read.Action("ActualizarViewBag", "Estadisticas"))

            )
            .Events(events => events.ExcelExport("gridInfraccionesInfo_ExportExcel"))
            .Pageable(p => p.Enabled(true))
            .Sortable()
            .Scrollable(scr => scr.Enabled(true))
            .Scrollable(scr => scr.Height(500))

            .ToolBar(tools =>
            {
                tools.Excel();
                tools.Search().Text("Buscar...");
            })

            .Excel(excel => excel
            .FileName("Estadistcas_Infracciones.xlsx")
            .Filterable(true)
            .AllPages(true)
            .ProxyURL(Url.Action("Excel_Export_Save", "Grid"))

            )
            .Events(e =>
            {

                // e.ExcelExport("showLoader");
                e.ExcelExport("hideLoader");
            })
            .Search(s =>
            {
                s.Field(c => c.Folio);
                s.Field(c => c.FolioTxt);
                s.Field(c => c.Estatus);
                s.Field(c => c.TipoCortesia);
                s.Field(c => c.Delegacion);
                s.Field(c => c.Municipio);
                s.Field(c => c.FechaInfraccion);
                s.Field(c => c.HoraInfraccion);
                s.Field(c => c.FechaVencimiento);
                s.Field(c => c.Carretera);
                s.Field(c => c.Tramo);
                s.Field(c => c.Kilometraje);
                s.Field(c => c.NombreConductor);
                s.Field(c => c.CURPConductor);
                s.Field(c => c.FechadeNacimiento);
                s.Field(c => c.DomicilioConductor);
                s.Field(c => c.LicenciaConductor);
                s.Field(c => c.TipoPersFisica);
                s.Field(c => c.TipoPersMoral);
                s.Field(c => c.OficialInfraccion);
                s.Field(c => c.Propietario);
                s.Field(c => c.CalifSalarios);
                s.Field(c => c.MontoPago);
                s.Field(c => c.ReciboPago);
                s.Field(c => c.FechaPago);
                s.Field(c => c.SerieVeh);
                s.Field(c => c.Placas);
                s.Field(c => c.numeroEconomicoVeh);
                s.Field(c => c.Marca);
                s.Field(c => c.Modelo);
                s.Field(c => c.TarjetadeCirculacion);               
                s.Field(c => c.Submarca);
                s.Field(c => c.Color);
                s.Field(c => c.EntidaddeReg);
                s.Field(c => c.TipodeVehículo);
                s.Field(c => c.TipodeServicio);
                s.Field(c => c.SubtipodeServicio);
                s.Field(c => c.TipoGarantia);
                s.Field(c => c.TipoAplicacion);
                s.Field(c => c.Motivo);
                s.Field(c => c.MotivoDesc);
            })
            .Events(events => events.DataBound("replaceLegend").DataBinding("replaceLegend"))
            
            )
            
        
    </div>
</div>



<script>
    var promises = [
        $.Deferred()
    ];
    function gridInfraccionesInfo_ExportExcel(e) {
        e.preventDefault();
        promises[0].resolve(e.workbook);
    }

    function FormatDate(date) {
        var cdate = convertDate(date);
        cdate = cdate == "01/01/0001" ? "" : cdate;
        return cdate;
    }

    function generateExcel2() {
        var grid = $("#gridInfraccionesInfo").data("kendoGrid");
        var pageSize = grid.dataSource._data.length;
        var dataSourceTotal = grid.dataSource.total();
        grid.dataSource.pageSize(dataSourceTotal);
        //grid.saveAsExcel();
        var exportPromises = [
            grid.saveAsExcel()
        ];

        $.when.apply($, exportPromises)
            .then(function () {
                promises[0].resolve(grid.options.excel.workbook);

                $.when.apply($, promises)
                    .then(function (infraccionesInfo) {
                        var sheets = [
                            infraccionesInfo.sheets[0],
                        ];

                        sheets[0].title = "Listado de Infracciones";

                        var workbook = new kendo.ooxml.Workbook({
                            sheets: sheets
                        });

                        kendo.saveAs({
                            dataURI: workbook.toDataURL(),
                            fileName: "Infracciones.xlsx"
                        });
                    });


                setTimeout(function () {
                    sitteg_success('Archivo descargado correctamente');
                }, 1500);
            });


    }
    $(document).ready(function () {
        var excelButton = $("a.k-grid-excel");

        excelButton.on("click", function () {
            console.log("SI CLICK")
            showLoading();
        });
    });

    function replaceExcelButtonLegend() {
        setTimeout(() => {
            var excelButton = $("a.k-grid-excel");

            excelButton.text("Exportar a Excel");
        }, 100);
    }
    $(document).ready(function () {
        replaceExcelButtonLegend();
    });
</script>

